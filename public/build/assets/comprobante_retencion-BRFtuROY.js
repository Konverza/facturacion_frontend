import{A as p}from"./autocomplete-i5sh6eXG.js";import"./autocomplete-BhlH6aML.js";let c=null,d=null,l=[],u=0,m=0,v=[{numero:"01",descripcion:"Factura"},{numero:"03",descripcion:"Comprobante de Crédito Fiscal"}],f=[{numero:1,descripcion:"Físico"},{numero:2,descripcion:"Electrónico"}],b=[{numero:"22",descripcion:"Retención de IVA 1%"},{numero:"C9",descripcion:"Otras Retenciones IVA casos especiales"}],r=[];$(function(){$.ajax({url:"/catalogo/cat_019",success:function(t){const o=document.getElementById("codActividad");new p(o,{data:t,maximumItems:5,threshold:1,fullWidth:!0}),d=t}}),$.ajax({url:"/departamentos/all",success:function(t){const o=$("#departamentoContribuyente");o.empty(),t.forEach(e=>{o.append(new Option(e.valores,e.codigo))}),o.on("change",function(){const e=$(this).val(),n=$("#municipioContribuyente");n.empty(),e&&t.find(i=>i.codigo===e).municipios.forEach(i=>{n.append(new Option(i.valores,i.codigo))})}),$("#departamentoContribuyente").trigger("change")}}),setInterval(()=>{const t=new Date,o=String(t.getHours()).padStart(2,"0"),e=String(t.getMinutes()).padStart(2,"0"),n=String(t.getSeconds()).padStart(2,"0"),a=`${o}:${e}:${n}`;$("#horaDTE").val(a)},1e3),$("#fechaDTE").val(new Date().toISOString().split("T")[0]),$("#generarDocumento").on("click",function(){g()}),$("#clienteExistenteModal").on("show.bs.modal",function(t){$.ajaxSetup({Headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),c?c.ajax.reload():(c=$("#tablaClientes").DataTable({processing:!0,serverSide:!0,ajax:{url:"/business/obtener_clientes",type:"POST",data:function(o){o._token=$('meta[name="csrf-token"]').attr("content"),o.search=$('input[type="search"]').val()}},order:["1","DESC"],pageLength:10,searching:!0,aoColumns:[{data:"numDocumento",render:function(o,e,n){return n.tipoDocumento=="13"?n.numDocumento.slice(0,-1)+"-"+n.numDocumento.slice(-1):n.numDocumento}},{data:"nombre"},{data:"id",width:"20%",render:function(o,e,n){return`
                                <button type="button" class="btn btn-primary btn-sm btnSeleccionarCliente" data-id="${n.id}">Seleccionar</button>
                            `}}],buttons:[],language:{url:"https://cdn.datatables.net/plug-ins/2.1.5/i18n/es-ES.json"}}),c.on("click",".btnSeleccionarCliente",function(){const o=$(this).data("id");$.ajax({url:`/business/obtener_cliente/${o}`,success:function(e){$("#tipoDoc").val(e.tipoDocumento),$("#tipoDoc").val(e.tipoDocumento),e.tipoDocumento=="13"?$("#nitContribuyente").val(e.numDocumento.slice(0,-1)+"-"+e.numDocumento.slice(-1)):$("#nitContribuyente").val(e.numDocumento),$("#nrcContribuyente").val(e.nrc.replace(/-/g,"")),$("#nombre").val(e.nombre),$("#nombreComercial").val(e.nombreComercial),$("#departamentoContribuyente").val(e.departamento),$("#departamentoContribuyente").trigger("change"),$("#municipioContribuyente").val(e.municipio),$("#complementoContribuyente").val(e.complemento),$("#correoContribuyente").val(e.correo),$("#telefonoContribuyente").val(e.telefono),$("#cerrarModalCliente").trigger("click");const n=d.find(a=>a.value===e.codActividad);n&&$("#codActividad").val(n.label)}})}))}),$("#cancelarDTE").on("click",function(){Swal.fire({title:"¿Cancelar generación de DTE?",text:"Se perderá toda la información ingresada",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, Cancelar",cancelButtonText:"No"}).then(t=>{t.isConfirmed&&(localStorage.removeItem("items_nc"),localStorage.removeItem("reteIva1_nc"),localStorage.removeItem("reteRenta_nc"),window.location="/business/dashboard")})}),$("#guardarDocFisico").on("click",function(){l.push({tipoDte:$("#tipoDocumentoFisico").val(),tipoDoc:1,numDocumento:$("#numeroDocumentoFisico").val(),fechaEmision:$("#fechaEmisionFisico").val(),montoSujetoGrav:$("#montoRetencionFisico").val(),codigoRetencionMH:$("#tipoRetencionFisico").val(),ivaRetenido:$("#montoIVAFisico").val(),descripcion:$("#descripcionDocumentoFisico").val()}),u+=parseFloat($("#montoRetencionFisico").val()),m+=parseFloat($("#montoIVAFisico").val()),s()}),$("#docElectronico").on("show.bs.modal",function(t){$("#nitContribuyente").val()==""?(Swal.fire({icon:"error",title:"Error",text:"Debe ingresar el NIT del contribuyente antes de continuar"}),t.preventDefault()):$("#nitBusqueda").val($("#nitContribuyente").val())}),$("#buscarDTE").on("click",function(){$("#loadingOverlay").removeClass("d-none"),$.ajax({url:"/business/buscar_dte",method:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content"),nitBusqueda:$("#nitBusqueda").val(),tipoDocumentoElectronico:$("#tipoDocumentoElectronico").val(),desdeBusqueda:$("#desdeBusqueda").val(),hastaBusqueda:$("#hastaBusqueda").val()},success:function(t){r=t,$("#loadingOverlay").addClass("d-none"),r.length>0?($("#resultadosDte").html(""),r.forEach(o=>{$("#resultadosDte").append(`
                            <tr>
                                <td>${o.fecha_emision}</td>
                                <td>${o.codigo_generacion}</td>
                                <td>$${o.monto.toFixed(2)}</td>
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm btnSeleccionarDTE" data-id="${o.codigo_generacion}">Seleccionar</button>
                                </td>
                            </tr>
                        `)})):$("#resultadosDte").html(`
                        <tr>
                            <td colspan="4" class="text-center">No se encontraron resultados</td>
                        </tr>
                    `)}})}),$(document).on("click",".btnSeleccionarDTE",function(){let t=r.find(o=>o.codigo_generacion==$(this).data("id"));l.push({tipoDocumento:t.tipo_dte,tipoGeneracion:2,numeroDocumento:t.codigo_generacion,fechaEmision:t.fecha_emision}),s()})});function g(){var a;$("#loadingOverlay").removeClass("d-none");const t=(a=d.find(i=>i.label===$("#codActividad").val()))==null?void 0:a.value,o=$("#codActividad").val().split("-").pop().trim();let e={nombre:$("#nombre").val(),nombreComercial:$("#nombreComercial").val(),codActividad:t,descActividad:o,telefono:$("#telefonoContribuyente").val(),correo:$("#correoContribuyente").val(),direccion:{departamento:$("#departamentoContribuyente").val(),municipio:$("#municipioContribuyente").val(),complemento:$("#complementoContribuyente").val()},tipoDocumento:$("#tipoDoc").val(),numDocumento:$("#nitContribuyente").val(),nrc:$("#nrcContribuyente").val()},n={nit:$("#nit").val(),receptor:e,cuerpoDocumento:l,resumen:{totalSujetoRetencion:u,totalIVAretenido:m},extension:null,apendice:null};$.ajax({url:"/business/factura?dte=comprobante_retencion",method:"POST",data:JSON.stringify(n),contentType:"application/json",success:function(i){i.status==201?i.message.estado=="PROCESADO"?Swal.fire({icon:"success",title:"Comprobante de Retención generado",text:"El Comprobante de Retención ha sido generado exitosamente",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none"),window.location.href="/business/dtes"}):i.message.estado=="CONTINGENCIA"?Swal.fire({icon:"warning",title:"Comprobante de Retención generado en CONTINGENCIA",text:"Se generó el Comprobante de Retención, pero no se envió a MH",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none"),window.location.href="/business/dtes"}):Swal.fire({icon:"error",title:"Comprobante de Retención Rechazado",text:`Motivo: ${i.message.observaciones}`}).then(()=>{$("#loadingOverlay").addClass("d-none")}):Swal.fire({icon:"error",title:"El Comprobante de Retención no se envió",text:"Ha ocurrido un error, verifica los datos e intenta de nuevo",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none")})},error:function(i){console.error(i),Swal.fire({icon:"error",title:"Error",text:"Ha ocurrido un error al generar el Comprobante de Retención",showConfirmButton:!1,timer:2e3})}})}function s(){let t=$("#documentosRelacionados"),o=$("#documentoRelacionado");$("#documentoRelacionadoExistente"),t.empty(),o.empty(),l.forEach(e=>{t.append(`
            <tr>
                <td>${f.find(n=>n.numero===e.tipoDoc).descripcion}</td>
                <td>${v.find(n=>n.numero===e.tipoDte).descripcion}</td>
                <td>${e.numDocumento}</td>
                <td>${b.find(n=>n.numero===e.codigoRetencionMH).descripcion}</td>
                <td>${e.descripcion}</td>
                <td>${e.fechaEmision}</td>
                <td>$${e.montoSujetoGrav}</td>
                <td>$${e.ivaRetenido}</td>
            </tr>
        `)})}
