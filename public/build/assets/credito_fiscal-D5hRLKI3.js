import{A as y}from"./autocomplete-i5sh6eXG.js";import"./autocomplete-BhlH6aML.js";let h=null,S=null,r=null,c=null,x=null,g=[],E=0,C=0,d=[],v=0,m=0,p=0;localStorage.getItem("items_ccf")&&(d=JSON.parse(localStorage.getItem("items_ccf")),f(),b(),s());localStorage.getItem("reteIva1_ccf")&&(v=parseFloat(localStorage.getItem("reteIva1_ccf")),$("#checkIvaRete1").prop("checked",!0),f(),b(),s());localStorage.getItem("perciIva1_ccf")&&(p=parseFloat(localStorage.getItem("perciIva1_ccf")),$("#checkIvaPerci1").prop("checked",!0),f(),b(),s());localStorage.getItem("reteRenta_ccf")&&(m=parseFloat(localStorage.getItem("reteRenta_ccf")),$("#checkReteRenta").prop("checked",!0),f(),b(),s());$(function(){$.ajax({url:"/catalogo/cat_019",success:function(a){const t=document.getElementById("codActividad");new y(t,{data:a,maximumItems:5,threshold:1,fullWidth:!0}),x=a}}),$.ajax({url:"/departamentos/all",success:function(a){const t=$("#departamentoContribuyente");t.empty(),a.forEach(o=>{t.append(new Option(o.valores,o.codigo))}),t.on("change",function(){const o=$(this).val(),e=$("#municipioContribuyente");e.empty(),o&&a.find(u=>u.codigo===o).municipios.forEach(u=>{e.append(new Option(u.valores,u.codigo))})}),$("#departamentoContribuyente").trigger("change")}});let l;function n(){l=setInterval(()=>{const a=new Date,t=String(a.getHours()).padStart(2,"0"),o=String(a.getMinutes()).padStart(2,"0"),e=String(a.getSeconds()).padStart(2,"0"),i=`${t}:${o}:${e}`;$("#horaDTE").val(i)},1e3)}n(),$(document).on("change","#checkFecha",function(){this.checked?Swal.fire({title:"¿Desea cambiar la fecha y hora del DTE?",text:"Tome en cuenta que enviar una fecha distinta a la actual puede ser observado por el Ministerio de Hacienda, ¿Desea continuar?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, Cambiar",cancelButtonText:"No"}).then(a=>{a.isConfirmed?clearInterval(l):$("#checkFecha").prop("checked",!1)}):n()}),$("#fechaDTE").val(new Date().toISOString().split("T")[0]),$("#descuento, #cantidad, #precio").on("change",function(){let a=$("#cantidad").val(),t=$("#precio").val(),o=$("#descuento").val(),e=I(a,t,o);console.log(e),$("#total").val(e),c.cantidad=a,c.precioUni=t,c.montoDescu=o;let i=$("#tipoVenta").val();i=="gravada"?c.ventaGravada=e:i=="exenta"?c.ventaExenta=e:i=="noSujeta"&&(c.ventaNoSuj=e),_(i,o)}),$("#agregar_item").on("click",function(){let a=$("#unidad").val(),t=$("#cantidad").val(),o=$("#descuento").val()||0,e=$("#producto").val();switch(c.id=d.length+1,c.tipoItem=$("#tipoItem").val(),c.uniMedida=a,c.montoDescu=o,c.descripcion=e,c.cantidad=t,$("#tipoVenta").val()){case"gravada":c.ventaGravada=c.precioUni*t-o;break;case"exenta":c.ventaExenta=c.precioUni*t-o;break;case"noSujeta":c.ventaNoSuj=c.precioUni*t-o;break}d.push(c),F(),f(),localStorage.setItem("items_ccf",JSON.stringify(d)),$("#cantidad").val(""),$("#precio").val(""),$("#descuento").val(""),$("#total").val(""),$("#producto").val(""),s()}),$("#items").on("click",".eliminar",function(){let a=$(this).data("id");d=d.filter(t=>t.id!==a),f(),s(),localStorage.setItem("items_ccf",JSON.stringify(d))}),$("#guardarDescuento").on("click",function(){let a=$("#descVentasGravadas").val();C=parseFloat(a),s(),$("#descuentosTotal").text("$"+C.toFixed(2))}),$("#generarDocumento").on("click",function(){k()}),$("#prodExistenteModal").on("show.bs.modal",function(a){r=null,$("#prodSeleccionado").addClass("d-none"),$.ajaxSetup({Headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),h?h.ajax.reload():(h=$("#tablaProds").DataTable({processing:!0,serverSide:!0,ajax:{url:"/business/obtener_productos",type:"POST",data:function(t){t._token=$('meta[name="csrf-token"]').attr("content"),t.search=$('input[type="search"]').val()}},order:["1","DESC"],pageLength:10,searching:!0,aoColumns:[{data:"codigo"},{data:"descripcion"},{data:"precioSinTributos",render:function(t,o,e){return`$${parseFloat(t).toFixed(2)}`}},{data:"id",width:"20%",render:function(t,o,e){return`
                                <button type="button" class="btn btn-primary btn-sm btnSeleccionarProd" data-id="${e.id}">Seleccionar</button>
                            `}}],buttons:[],language:{url:"https://cdn.datatables.net/plug-ins/2.1.5/i18n/es-ES.json"}}),h.on("click",".btnSeleccionarProd",function(){const t=$(this).data("id");$.ajax({url:`/business/obtener_producto/${t}`,success:function(o){$("#prodSeleccionado").removeClass("d-none"),r=o,r.precioUni=r.precioSinTributos,$("#prodDesc").text(r.descripcion)}})}))}),$("#clienteExistenteModal").on("show.bs.modal",function(a){$.ajaxSetup({Headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),S?S.ajax.reload():(S=$("#tablaClientes").DataTable({processing:!0,serverSide:!0,ajax:{url:"/business/obtener_clientes",type:"POST",data:function(t){t._token=$('meta[name="csrf-token"]').attr("content"),t.search=$('input[type="search"]').val()}},order:["1","DESC"],pageLength:10,searching:!0,aoColumns:[{data:"numDocumento",render:function(t,o,e){return e.tipoDocumento=="13"?e.numDocumento.slice(0,-1)+"-"+e.numDocumento.slice(-1):e.numDocumento}},{data:"nombre"},{data:"id",width:"20%",render:function(t,o,e){return`
                                <button type="button" class="btn btn-primary btn-sm btnSeleccionarCliente" data-id="${e.id}">Seleccionar</button>
                            `}}],buttons:[],language:{url:"https://cdn.datatables.net/plug-ins/2.1.5/i18n/es-ES.json"}}),S.on("click",".btnSeleccionarCliente",function(){const t=$(this).data("id");$.ajax({url:`/business/obtener_cliente/${t}`,success:function(o){$("#tipoDoc").val(o.tipoDocumento),$("#nitContribuyente").val(o.numDocumento),$("#nrcContribuyente").val(o.nrc.replace(/-/g,"")),$("#nombre").val(o.nombre),$("#nombreComercial").val(o.nombreComercial),$("#departamentoContribuyente").val(o.departamento),$("#departamentoContribuyente").trigger("change"),$("#municipioContribuyente").val(o.municipio),$("#complementoContribuyente").val(o.complemento),$("#correoContribuyente").val(o.correo),$("#telefonoContribuyente").val(o.telefono),$("#cerrarModalCliente").trigger("click");const e=x.find(i=>i.value===o.codActividad);e&&$("#codActividad").val(e.label)}})}))}),$("#aggitem").on("show.bs.modal",function(a){F()}),$("#aggitem .form-check-input").on("change",function(){_($("#tipoVenta").val(),$("#descuento").val())}),$("#cantidadExistente, #descuentoExistente").on("change",function(){let a=$("#cantidadExistente").val()||0,t=$("#descuentoExistente").val()||0,o=I(a,r.precioUni,t);$("#totalExistente").val(parseFloat(o).toFixed(4))}),$("#btnAgregarProd").on("click",function(){let a=$("#cantidadExistente").val()||0,t=$("#descuentoExistente").val()||0,o=$("#tipoVentaExistente").val();switch(r.id=d.length+1,r.cantidad=a,r.montoDescu=t,r.ventaGravada=0,r.ventaExenta=0,r.ventaNoSuj=0,r.tributos.forEach(e=>{if(e.codigo=="20"&&o!="gravada"){r.tributos=r.tributos.filter(i=>i.codigo!=="20");return}e.es_porcentaje?e.calculado=(r.precioUni*a-t)*e.valor:e.calculado=e.valor*r.cantidad}),o){case"gravada":r.ventaGravada=$("#totalExistente").val();break;case"exenta":r.ventaExenta=$("#totalExistente").val();break;case"noSujeta":r.ventaNoSuj=$("#totalExistente").val();break}d.push(r),f(),localStorage.setItem("items_ccf",JSON.stringify(d)),$("#cantidadExistente").val(""),$("#descuentoExistente").val(""),$("#totalExistente").val(""),s()}),$("#checkIvaRete1").on("change",function(){if($(this).prop("checked")){let a=0;d.forEach(t=>{a+=parseFloat(t.ventaGravada)}),v=a*.01,localStorage.setItem("reteIva1",v)}else v=0,localStorage.removeItem("reteIva1_ccf");s()}),$("#checkReteRenta").on("change",function(){if($(this).prop("checked")){let a=0;d.forEach(t=>{a+=parseFloat(t.ventaGravada)}),m=a*.1,localStorage.setItem("reteRenta_ccf",m)}else m=0,localStorage.removeItem("reteRenta_ccf");s()}),$("#checkIvaPerci1").on("change",function(){if($(this).prop("checked")){let a=0;d.forEach(t=>{a+=parseFloat(t.ventaGravada)}),p=a*.01,localStorage.setItem("perciIva1_ccf",p)}else p=0,localStorage.removeItem("perciIva1_ccf");s()}),$("#cancelarDTE").on("click",function(){Swal.fire({title:"¿Cancelar generación de DTE?",text:"Se perderá toda la información ingresada",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, Cancelar",cancelButtonText:"No"}).then(a=>{a.isConfirmed&&(localStorage.removeItem("items_ccf"),localStorage.removeItem("reteIva1_ccf"),localStorage.removeItem("reteRenta_ccf"),window.location="/business/dashboard")})})});function I(l=0,n=0,a=0){return(l*n-a).toFixed(4)}function s(){D();let l=0,n=0,a=0;d.forEach(t=>{l+=parseFloat(t.ventaGravada)+parseFloat(t.ventaExenta)+parseFloat(t.ventaNoSuj)}),n=l-C+E,a=n-v-m+p,$("#reteIVA").text("$"+v.toFixed(2)),$("#reteRenta").text("$"+m.toFixed(2)),$("#perciIVA").text("$"+p.toFixed(2)),$("#subTotalGeneral").text("$"+l.toFixed(2)),$("#montoTotalOperacion").text("$"+n.toFixed(2)),$("#totalPagar").text("$"+a.toFixed(2)),$("#monto").val(a)}function k(){var o;$("#loadingOverlay").removeClass("d-none");const l=(o=x.find(e=>e.label===$("#codActividad").val()))==null?void 0:o.value,n=$("#codActividad").val().split("-").pop().trim();let a={nombre:$("#nombre").val(),nombreComercial:$("#nombreComercial").val(),codActividad:l,descActividad:n,telefono:$("#telefonoContribuyente").val(),correo:$("#correoContribuyente").val(),direccion:{departamento:$("#departamentoContribuyente").val(),municipio:$("#municipioContribuyente").val(),complemento:$("#complementoContribuyente").val()},nit:$("#nitContribuyente").val(),nrc:$("#nrcContribuyente").val()},t={nit:$("#nit").val(),receptor:a,cuerpoDocumento:[],documentoRelacionado:null,ventaTercero:null,resumen:{descuNoSuj:0,descuExtenta:0,descuGravada:0,porcentajeDescuento:0,ivaRete1:v.toFixed(2),ivaPerci1:p.toFixed(2),reteRenta_ccf:m.toFixed(2),saldoFavor:0,condicionOperacion:$("#condicionOperacion").val()},extension:null,apendice:null,pagos:null,numPagoElectronico:null};$("#checkFecha").prop("checked")&&(t.fecEmi=$("#fechaDTE").val(),t.horEmi=$("#horaDTE").val()),$("#nitVentaTerceros").val()!=""&&$("#nombreVentaTerceros").val()!=""&&(t.ventaTercero={nit:$("#nitVentaTerceros").val(),nombre:$("#nombreVentaTerceros").val()}),$("#docuEntrega").val()!=""&&$("#nombEntrega").val()!=""&&$("#docuRecibe").val()!=""&&$("#nombRecibe").val()!=""&&(t.extension={docuEntrega:$("#docuEntrega").val(),nombEntrega:$("#nombEntrega").val(),docuRecibe:$("#docuRecibe").val(),nombRecibe:$("#nombRecibe").val()}),$("#observacionesDoc").val()!=""&&(t.extension={observaciones:$("#observacionesDoc").val()}),d.forEach(e=>{let i=[];e.tributos.forEach(u=>{u.codigo!=="20"&&i.push(u.codigo)}),i.length==0&&(i=null),t.cuerpoDocumento.push({tipoItem:e.tipoItem,numeroDocumento:null,cantidad:e.cantidad,codigo:e.codigo||null,codTributo:null,uniMedida:e.uniMedida,descripcion:e.descripcion,precioUni:e.precioUni,montoDescu:e.montoDescu,ventaNoSuj:e.ventaNoSuj,ventaExenta:e.ventaExenta,ventaGravada:e.ventaGravada,tributos:i,psv:e.precioUni,noGravado:0})}),t.resumen.tributos=g,$.ajax({url:"/business/factura?dte=credito_fiscal",method:"POST",data:JSON.stringify(t),contentType:"application/json",success:function(e){e.status==201?e.message.estado=="PROCESADO"?Swal.fire({icon:"success",title:"Crédito Fiscal generado",text:"El Crédito Fiscal ha sido generado exitosamente",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none"),localStorage.removeItem("items_ccf"),localStorage.removeItem("reteIva1_ccf"),localStorage.removeItem("reteRenta_ccf"),window.location.href="/business/dtes"}):e.message.estado=="CONTINGENCIA"?Swal.fire({icon:"warning",title:"Crédito Fiscal generado en CONTINGENCIA",text:"Se generó el Crédito Fiscal, pero no se envió a MH",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none"),window.location.href="/business/dtes"}):Swal.fire({icon:"error",title:"Crédito Fiscal Rechazado",text:`Motivo: ${e.message.observaciones}`}).then(()=>{$("#loadingOverlay").addClass("d-none")}):Swal.fire({icon:"error",title:"El Crédito Fiscal no se envió",text:"Ha ocurrido un error, verifica los datos e intenta de nuevo",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none")})},error:function(e){console.error(e),Swal.fire({icon:"error",title:"Error",text:"Ha ocurrido un error al generar el Crédito Fiscal",showConfirmButton:!1,timer:2e3})}})}function f(){let l=$("#items");l.empty(),d.forEach(n=>{l.append(`
            <tr>
                <td>${n.uniMedida}</td>
                <td>${n.descripcion}</td>
                <td>${n.cantidad}</td>
                <td>$${parseFloat(n.precioUni).toFixed(2)}</td>
                <td>$${parseFloat(n.montoDescu).toFixed(2)}</td>
                <td>
                    $${parseFloat(n.ventaGravada).toFixed(4)}
                </td>
                <td>
                    $${parseFloat(n.ventaExenta).toFixed(4)}
                </td>
                <td>
                    $${parseFloat(n.ventaNoSuj).toFixed(4)}
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm eliminar" data-id="${n.id}">Eliminar</button>
                </td>
            </tr>
        `)})}function _(l="gravada",n=0){$(".form-check-input").each(function(){if($(this).prop("checked")){let e={codigo:$(this).val(),descripcion:$(this).next("label").text().trim(),valor:$(this).data("valor"),es_porcentaje:$(this).data("porcentaje"),calculado:0};c.tributos.some(i=>i.codigo===e.codigo)||c.tributos.push(e)}else c.tributos=c.tributos.filter(e=>e.codigo!==$(this).val())});let a="",t=0;c.tributos.forEach(e=>{if(e.codigo=="20"&&l!="gravada"){c.tributos=c.tributos.filter(u=>u.codigo!=="20");return}let i=0;e.es_porcentaje?i=(c.precioUni*c.cantidad-n)*e.valor:i=e.valor*c.cantidad,a+=`
            <div class="alert alert-info" role="alert">
                ${e.descripcion}: $${i.toFixed(4)}
            </div>
        `,e.calculado=i,t+=i}),$("#tributosAplicados").html(a);const o=c.precioUni*c.cantidad-n+t;$("#total").val(o.toFixed(4))}function b(){g=[],E=0,d.forEach(l=>{l.tributos.forEach(n=>{g.some(a=>a.codigo===n.codigo)?g.find(a=>a.codigo===n.codigo).valor+=n.calculado:g.push({codigo:n.codigo,descripcion:n.descripcion,valor:n.calculado}),E+=n.calculado})})}function D(){b();let l=$("#tributos");l.empty(),g.forEach(n=>{l.append(`
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="text-end fw-bold">${n.descripcion}</td>
                <td>$${n.valor.toFixed(2)}</td>
            </tr>
        `)})}function F(){c={id:1,tipoItem:null,cantidad:null,codigo:null,uniMedida:null,descripcion:null,precioUni:0,montoDescu:0,ventaNoSuj:0,ventaExenta:0,ventaGravada:0,tributos:[],psv:0}}
