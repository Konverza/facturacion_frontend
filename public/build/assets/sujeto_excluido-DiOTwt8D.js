let d=null,a=null,s=0,i=[],r=0,u=0;localStorage.getItem("items_fse")&&(i=JSON.parse(localStorage.getItem("items_fse")),m(),c());$(function(){$.ajax({url:"/departamentos/all",success:function(o){const t=$("#departamentoContribuyente");t.empty(),o.forEach(e=>{t.append(new Option(e.valores,e.codigo))}),t.on("change",function(){const e=$(this).val(),n=$("#municipioContribuyente");n.empty(),e&&o.find(l=>l.codigo===e).municipios.forEach(l=>{n.append(new Option(l.valores,l.codigo))})}),$("#departamentoContribuyente").trigger("change")}}),setInterval(()=>{const o=new Date,t=String(o.getHours()).padStart(2,"0"),e=String(o.getMinutes()).padStart(2,"0"),n=String(o.getSeconds()).padStart(2,"0"),p=`${t}:${e}:${n}`;$("#horaDTE").val(p)},1e3),$("#fechaDTE").val(new Date().toISOString().split("T")[0]),$("#descuento, #cantidad, #precio").on("change",function(){let o=$("#cantidad").val(),t=$("#precio").val(),e=$("#descuento").val(),n=g(o,t,e);$("#total").val(n),a.cantidad=o,a.precioUni=t,a.montoDescu=e,a.compra=n}),$("#agregar_item").on("click",function(){let o=$("#unidad").val(),t=$("#cantidad").val(),e=$("#descuento").val()||0,n=$("#producto").val();a.id=i.length+1,a.tipoItem=$("#tipoItem").val(),a.uniMedida=o,a.montoDescu=e,a.descripcion=n,a.cantidad=t,a.compra=$("#total").val(),i.push(a),f(),m(),localStorage.setItem("items_fse",JSON.stringify(i)),$("#cantidad").val(""),$("#precio").val(""),$("#descuento").val(""),$("#total").val(""),$("#producto").val(""),c()}),$("#items").on("click",".eliminar",function(){let o=$(this).data("id");i=i.filter(t=>t.id!==o),m(),c(),localStorage.setItem("items_fse",JSON.stringify(i))}),$("#guardarDescuento").on("click",function(){let o=$("#descVentasGravadas").val();s=parseFloat(o),c()}),$("#generarDocumento").on("click",function(){v()}),$("#clienteExistenteModal").on("show.bs.modal",function(o){$.ajaxSetup({Headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),d?d.ajax.reload():(d=$("#tablaClientes").DataTable({processing:!0,serverSide:!0,ajax:{url:"/business/obtener_clientes",type:"POST",data:function(t){t._token=$('meta[name="csrf-token"]').attr("content"),t.search=$('input[type="search"]').val()}},order:["1","DESC"],pageLength:10,searching:!0,aoColumns:[{data:"numDocumento",render:function(t,e,n){return n.tipoDocumento=="13"?n.numDocumento.slice(0,-1)+"-"+n.numDocumento.slice(-1):n.numDocumento}},{data:"nombre"},{data:"id",width:"20%",render:function(t,e,n){return`
                                <button type="button" class="btn btn-primary btn-sm btnSeleccionarCliente" data-id="${n.id}">Seleccionar</button>
                            `}}],buttons:[],language:{url:"https://cdn.datatables.net/plug-ins/2.1.5/i18n/es-ES.json"}}),d.on("click",".btnSeleccionarCliente",function(){const t=$(this).data("id");$.ajax({url:`/business/obtener_cliente/${t}`,success:function(e){$("#tipoDoc").val(e.tipoDocumento),e.tipoDocumento=="13"?$("#nitContribuyente").val(e.numDocumento.slice(0,-1)+"-"+e.numDocumento.slice(-1)):$("#nitContribuyente").val(e.numDocumento),$("#nombreContribuyente").val(e.nombre),$("#departamentoContribuyente").val(e.departamento),$("#departamentoContribuyente").trigger("change"),$("#municipioContribuyente").val(e.municipio),$("#complementoContribuyente").val(e.complemento),$("#correoContribuyente").val(e.correo),$("#telefonoContribuyente").val(e.telefono),$("#cerrarModalCliente").trigger("click")}})}))}),$("#aggitem").on("show.bs.modal",function(o){f()}),$("#checkIvaRete1").on("change",function(){if($(this).prop("checked")){let o=0;i.forEach(t=>{o+=parseFloat(t.ventaGravada)}),r=o/1.13*.01,localStorage.setItem("reteIva1",r)}else r=0,localStorage.removeItem("reteIva1_fse");c()}),$("#cancelarDTE").on("click",function(){Swal.fire({title:"¿Cancelar generación de DTE?",text:"Se perderá toda la información ingresada",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, Cancelar",cancelButtonText:"No"}).then(o=>{o.isConfirmed&&(localStorage.removeItem("items_fse"),localStorage.removeItem("reteIva1_fse"),localStorage.removeItem("reteRenta_fse"),window.location="/business/dashboard")})})});function g(o=0,t=0,e=0){return(o*t-e).toFixed(4)}function c(){let o=0,t=0,e=0;i.forEach(n=>{o+=parseFloat(n.compra)}),u=o*.1,t=o-s,e=t-r-u,$("#reteIVA").text("$"+r.toFixed(2)),$("#reteRenta").text("$"+u.toFixed(2)),$("#montoTotalOperacion").text("$"+t.toFixed(2)),$("#totalPagar").text("$"+e.toFixed(2)),$("#monto").val(e),$("#descuentosTotal").text("$"+s.toFixed(2))}function v(){$("#loadingOverlay").removeClass("d-none");let o={nombre:$("#nombreContribuyente").val(),telefono:$("#telefonoContribuyente").val(),correo:$("#correoContribuyente").val(),direccion:{departamento:$("#departamentoContribuyente").val(),municipio:$("#municipioContribuyente").val(),complemento:$("#complementoContribuyente").val()},tipoDocumento:$("#tipoDoc").val(),numDocumento:$("#nitContribuyente").val().replace(/-/g,"")},t={nit:$("#nit").val(),sujetoExcluido:o,cuerpoDocumento:[],resumen:{descu:s,totalDescu:0,ivaRete1:r,condicionOperacion:$("#condicionOperacion").val(),observaciones:$("#observacionesDoc").val()},apendice:null};i.forEach(e=>{t.cuerpoDocumento.push({tipoItem:e.tipoItem,cantidad:e.cantidad,uniMedida:e.uniMedida,descripcion:e.descripcion,precioUni:e.precioUni,codigo:e.codigo||null,montoDescu:e.montoDescu,compra:e.compra})}),$.ajax({url:"/business/factura?dte=sujeto_excluido",method:"POST",data:JSON.stringify(t),contentType:"application/json",success:function(e){e.status==201?e.message.estado=="PROCESADO"?Swal.fire({icon:"success",title:"Factura generada",text:"La factura ha sido generada exitosamente",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none"),localStorage.removeItem("items_fse"),localStorage.removeItem("reteIva1_fse"),localStorage.removeItem("reteRenta_fse"),window.location.href="/business/dtes"}):e.message.estado=="CONTINGENCIA"?Swal.fire({icon:"warning",title:"Factura generada en CONTINGENCIA",text:"Se generó la factura, pero no se envió a MH",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none"),window.location.href="/business/dtes"}):Swal.fire({icon:"error",title:"Factura Rechazada",text:`Motivo: ${e.message.observaciones}`}).then(()=>{$("#loadingOverlay").addClass("d-none")}):Swal.fire({icon:"error",title:"La factura no se envió",text:"Ha ocurrido un error, verifica los datos e intenta de nuevo",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none")})},error:function(e){console.error(e),Swal.fire({icon:"error",title:"Error",text:"Ha ocurrido un error al generar la factura",showConfirmButton:!1,timer:2e3})}})}function m(){let o=$("#items");o.empty(),i.forEach(t=>{o.append(`
            <tr>
                <td>${t.uniMedida}</td>
                <td>${t.descripcion}</td>
                <td>${t.cantidad}</td>
                <td>$${parseFloat(t.precioUni).toFixed(2)}</td>
                <td>$${parseFloat(t.montoDescu).toFixed(2)}</td>
                <td>
                    $${parseFloat(t.compra).toFixed(4)}
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm eliminar" data-id="${t.id}">Eliminar</button>
                </td>
            </tr>
        `)})}function f(){a={id:1,tipoItem:null,cantidad:null,uniMedida:null,descripcion:null,precioUni:0,codigo:null,montoDescu:0,compra:0}}
