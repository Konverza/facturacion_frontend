import{A as h}from"./autocomplete-i5sh6eXG.js";import"./autocomplete-BhlH6aML.js";let u=null,m=null,l=null,i=null,f=null,x=null,y=0,c=[];localStorage.getItem("items_fex")&&(c=JSON.parse(localStorage.getItem("items_fex")),p(),s());$(function(){$.ajax({url:"/catalogo/cat_020",success:function(t){const e=document.getElementById("codPais");new h(e,{data:t,maximumItems:5,threshold:1,fullWidth:!0}),f=t}}),$.ajax({url:"/catalogo/cat_019",success:function(t){const e=document.getElementById("codActividad");new h(e,{data:t,maximumItems:5,threshold:1,fullWidth:!0}),x=t}}),$.ajax({url:"/departamentos/all",success:function(t){const e=$("#departamentoContribuyente");e.empty(),t.forEach(a=>{e.append(new Option(a.valores,a.codigo))}),e.on("change",function(){const a=$(this).val(),n=$("#municipioContribuyente");n.empty(),a&&t.find(r=>r.codigo===a).municipios.forEach(r=>{n.append(new Option(r.valores,r.codigo))})}),$("#departamentoContribuyente").trigger("change")}}),setInterval(()=>{const t=new Date,e=String(t.getHours()).padStart(2,"0"),a=String(t.getMinutes()).padStart(2,"0"),n=String(t.getSeconds()).padStart(2,"0"),d=`${e}:${a}:${n}`;$("#horaDTE").val(d)},1e3),$("#fechaDTE").val(new Date().toISOString().split("T")[0]),$("#descuento, #cantidad, #precio").on("change",function(){let t=$("#cantidad").val(),e=$("#precio").val(),a=$("#descuento").val(),n=S(t,e,a);$("#total").val(n),i.cantidad=t,i.precioUni=e,i.montoDescu=a,i.ventaGravada=n}),$("#agregar_item").on("click",function(){let t=$("#unidad").val(),e=$("#cantidad").val(),a=$("#descuento").val()||0,n=$("#producto").val();i.id=c.length+1,i.tipoItem=$("#tipoItem").val(),i.uniMedida=t,i.montoDescu=a,i.descripcion=n,i.cantidad=e,i.ventaGravada=i.precioUni*e,c.push(i),C(),p(),localStorage.setItem("items_fex",JSON.stringify(c)),$("#cantidad").val(""),$("#precio").val(""),$("#descuento").val(""),$("#total").val(""),$("#producto").val(""),s()}),$("#items").on("click",".eliminar",function(){let t=$(this).data("id");c=c.filter(e=>e.id!==t),p(),s(),localStorage.setItem("items_fex",JSON.stringify(c))}),$("#generarDocumento").on("click",function(){E()}),$("#prodExistenteModal").on("show.bs.modal",function(t){l=null,$("#prodSeleccionado").addClass("d-none"),$.ajaxSetup({Headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),u?u.ajax.reload():(u=$("#tablaProds").DataTable({processing:!0,serverSide:!0,ajax:{url:"/business/obtener_productos",type:"POST",data:function(e){e._token=$('meta[name="csrf-token"]').attr("content"),e.search=$('input[type="search"]').val()}},order:["1","DESC"],pageLength:10,searching:!0,aoColumns:[{data:"codigo"},{data:"descripcion"},{data:"precioSinTributos",render:function(e,a,n){return`$${parseFloat(e).toFixed(2)}`}},{data:"id",width:"20%",render:function(e,a,n){return`
                                <button type="button" class="btn btn-primary btn-sm btnSeleccionarProd" data-id="${n.id}">Seleccionar</button>
                            `}}],buttons:[],language:{url:"https://cdn.datatables.net/plug-ins/2.1.5/i18n/es-ES.json"}}),u.on("click",".btnSeleccionarProd",function(){const e=$(this).data("id");$.ajax({url:`/business/obtener_producto/${e}`,success:function(a){$("#prodSeleccionado").removeClass("d-none"),l=a,l.precioUni=l.precioSinTributos,$("#prodDesc").text(l.descripcion)}})}))}),$("#clienteExistenteModal").on("show.bs.modal",function(t){$.ajaxSetup({Headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),m?m.ajax.reload():(m=$("#tablaClientes").DataTable({processing:!0,serverSide:!0,ajax:{url:"/business/obtener_clientes",type:"POST",data:function(e){e._token=$('meta[name="csrf-token"]').attr("content"),e.search=$('input[type="search"]').val()}},order:["1","DESC"],pageLength:10,searching:!0,aoColumns:[{data:"numDocumento",render:function(e,a,n){return n.tipoDocumento=="13"?n.numDocumento.slice(0,-1)+"-"+n.numDocumento.slice(-1):n.numDocumento}},{data:"nombre"},{data:"id",width:"20%",render:function(e,a,n){return`
                                <button type="button" class="btn btn-primary btn-sm btnSeleccionarCliente" data-id="${n.id}">Seleccionar</button>
                            `}}],buttons:[],language:{url:"https://cdn.datatables.net/plug-ins/2.1.5/i18n/es-ES.json"}}),m.on("click",".btnSeleccionarCliente",function(){const e=$(this).data("id");$.ajax({url:`/business/obtener_cliente/${e}`,success:function(a){if(!a.codPais)Swal.fire({icon:"error",title:"Error",text:"El cliente seleccionado no tiene información de exportación en su perfil",showConfirmButton:!1,timer:2e3});else{$("#tipoDoc").val(a.tipoDocumento),$("#nitContribuyente").val(a.numDocumento),$("#nombre").val(a.nombre),$("#tipoPersona").val(a.tipoPersona),$("#complementoContribuyente").val(a.complemento),$("#correoContribuyente").val(a.correo),$("#telefonoContribuyente").val(a.telefono),$("#cerrarModalCliente").trigger("click");const n=f.find(r=>r.value===a.codPais);n&&$("#codPais").val(n.label);const d=x.find(r=>r.value===a.codActividad);d&&$("#codActividad").val(d.label)}}})}))}),$("#aggitem").on("show.bs.modal",function(t){C()}),$("#aggitem .form-check-input").on("change",function(){calcular_tributos_item()}),$("#cantidadExistente, #descuentoExistente").on("change",function(){let t=$("#cantidadExistente").val()||0,e=$("#descuentoExistente").val()||0,a=S(t,l.precioUni,e);$("#totalExistente").val(parseFloat(a).toFixed(4))}),$("#btnAgregarProd").on("click",function(){let t=$("#cantidadExistente").val()||0,e=$("#descuentoExistente").val()||0;l.id=c.length+1,l.cantidad=t,l.montoDescu=e,l.ventaGravada=$("#totalExistente").val(),c.push(l),p(),localStorage.setItem("items_fex",JSON.stringify(c)),$("#cantidadExistente").val(""),$("#descuentoExistente").val(""),$("#totalExistente").val(""),s()}),$("#cancelarDTE").on("click",function(){Swal.fire({title:"¿Cancelar generación de DTE?",text:"Se perderá toda la información ingresada",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, Cancelar",cancelButtonText:"No"}).then(t=>{t.isConfirmed&&(localStorage.removeItem("items_fex"),window.location="/business/dashboard")})}),$("#seguro, #flete").on("change",function(){s()})});function S(t=0,e=0,a=0){return(t*e-a).toFixed(4)}function s(){let t=0,e=0,a=0,n=$("#seguro").val()||0,d=$("#flete").val()||0;c.forEach(r=>{t+=parseFloat(r.ventaGravada)}),e=t-y,a=e+parseFloat(n)+parseFloat(d),$("#subTotalGeneral").text("$"+t.toFixed(2)),$("#montoTotalOperacion").text("$"+e.toFixed(2)),$("#totalPagar").text("$"+a.toFixed(2)),$("#monto").val(a)}function E(){var g,b;$("#loadingOverlay").removeClass("d-none"),(g=f.find(o=>o.label===$("#codActividad").val()))==null||g.value;const t=$("#codActividad").val().split("-").pop().trim(),e=(b=f.find(o=>o.label===$("#codPais").val()))==null?void 0:b.value,a=$("#codPais").val().split("-").pop().trim(),n=$("#incoterms").val(),d=$("#incoterms option:selected").text();let r={tipoDocumento:$("#tipoDoc").val(),numDocumento:$("#nitContribuyente").val(),nombre:$("#nombre").val(),nombreComercial:$("#nombre").val(),descActividad:t,codPais:e,nombrePais:a,complemento:$("#complementoContribuyente").val(),telefono:$("#telefonoContribuyente").val(),correo:$("#correoContribuyente").val(),tipoPersona:$("#tipoPersona").val()},v={nit:$("#nit").val(),emisor:{regimen:$("#regimen").val(),recintoFiscal:$("#recinto").val(),tipoItemExpor:$("#tipoItemExpor").val()},receptor:r,cuerpoDocumento:[],otrosDocumentos:null,resumen:{porcentajeDescuento:0,condicionOperacion:1,codIncoterms:n,descIncoterms:d,flete:$("#flete").val(),seguro:$("#seguro").val(),descuento:0},apendice:null};c.forEach(o=>{v.cuerpoDocumento.push({cantidad:o.cantidad,codigo:o.codigo||null,uniMedida:o.uniMedida,descripcion:o.descripcion,precioUni:o.precioUni,montoDescu:o.montoDescu,ventaGravada:o.ventaGravada,noGravado:0})}),$.ajax({url:"/business/factura?dte=factura_exportacion",method:"POST",data:JSON.stringify(v),contentType:"application/json",success:function(o){o.status==201?o.message.estado=="PROCESADO"?Swal.fire({icon:"success",title:"Factura generada",text:"La factura ha sido generada exitosamente",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none"),localStorage.removeItem("items_fex"),localStorage.removeItem("reteIva1"),localStorage.removeItem("reteRenta"),window.location.href="/business/dtes"}):o.message.estado=="CONTINGENCIA"?Swal.fire({icon:"warning",title:"Factura generada en CONTINGENCIA",text:"Se generó la factura, pero no se envió a MH",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none"),window.location.href="/business/dtes"}):Swal.fire({icon:"error",title:"Factura Rechazada",text:`Motivo: ${o.message.observaciones}`}).then(()=>{$("#loadingOverlay").addClass("d-none")}):Swal.fire({icon:"error",title:"La factura no se envió",text:"Ha ocurrido un error, verifica los datos e intenta de nuevo",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none")})},error:function(o){console.error(o),Swal.fire({icon:"error",title:"Error",text:"Ha ocurrido un error al generar la factura",showConfirmButton:!1,timer:2e3})}})}function p(){let t=$("#items");t.empty(),c.forEach(e=>{t.append(`
            <tr>
                <td>${e.uniMedida}</td>
                <td>${e.descripcion}</td>
                <td>${e.cantidad}</td>
                <td>$${parseFloat(e.precioUni).toFixed(2)}</td>
                <td>$${parseFloat(e.montoDescu).toFixed(2)}</td>
                <td>
                    $${parseFloat(e.ventaGravada).toFixed(4)}
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm eliminar" data-id="${e.id}">Eliminar</button>
                </td>
            </tr>
        `)})}function C(){i={id:1,tipoItem:null,cantidad:null,codigo:null,uniMedida:null,descripcion:null,precioUni:0,montoDescu:0,ventaGravada:0}}
