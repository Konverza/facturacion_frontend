let r=[],c=0;$(function(){$.ajax({url:"/departamentos/all",success:function(t){const o=$("#departamentoContribuyente");o.empty(),t.forEach(e=>{o.append(new Option(e.valores,e.codigo))}),o.on("change",function(){const e=$(this).val(),n=$("#municipioContribuyente");n.empty(),e&&t.find(a=>a.codigo===e).municipios.forEach(a=>{n.append(new Option(a.valores,a.codigo))})}),$("#departamentoContribuyente").trigger("change")}}),setInterval(()=>{$("#horaDTE").val(new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}))},1e3),$("#fechaDTE").val(new Date().toISOString().split("T")[0]),$("#descuento, #cantidad, #precio").on("change",function(){let t=$("#cantidad").val(),o=$("#precio").val(),e=$("#descuento").val(),n=s(t,o,e);$("#total").val(n)}),$("#checkContribuyente").on("change",function(){$(this).prop("checked")?(console.log("checked"),$("#nombreContribuyente").prop("disabled",!0),$("#telefonoContribuyente").prop("disabled",!0),$("#correoContribuyente").prop("disabled",!0),$("#departamentoContribuyente").prop("disabled",!0),$("#municipioContribuyente").prop("disabled",!0),$("#complementoContribuyente").prop("disabled",!0),$("#tipoDoc").prop("disabled",!0),$("#nitContribuyente").prop("disabled",!0)):(console.log("unchecked"),$("#nombreContribuyente").prop("disabled",!1),$("#telefonoContribuyente").prop("disabled",!1),$("#correoContribuyente").prop("disabled",!1),$("#departamentoContribuyente").prop("disabled",!1),$("#municipioContribuyente").prop("disabled",!1),$("#complementoContribuyente").prop("disabled",!1),$("#tipoDoc").prop("disabled",!1),$("#nitContribuyente").prop("disabled",!1))}),$("#agregar_item").on("click",function(){let t=$("#unidad").val(),o=$("#unidad option:selected").text(),e=$("#cantidad").val(),n=$("#precio").val(),i=$("#descuento").val()||0,a=$("#total").val(),d=$("#producto").val(),u={id:r.length+1,unidad:t,cantidad:e,precio:n,descuento:i,total:a,descripcion:d};r.push(u),$("#items").append(`<tr>
            <td>${o}</td>
            <td>${d}</td>
            <td>${e}</td>
            <td>$${parseFloat(n).toFixed(2)}</td>
            <td>$${parseFloat(i).toFixed(2)}</td>
            <td>$${parseFloat(a).toFixed(2)}</td>
            <td>
                <button class="btn btn-danger btn-sm eliminar" data-id="${r.length+1}">
                    Eliminar
                </button>
            </td>
        </tr>`),$("#cantidad").val(""),$("#precio").val(""),$("#descuento").val(""),$("#total").val(""),$("#producto").val(""),l()}),$("#items").on("click",".eliminar",function(){let t=$(this).data("id");r=r.filter(o=>o.id!==t),$(this).closest("tr").remove(),l()}),$("#guardarDescuento").on("click",function(){let t=$("#descVentasGravadas").val();c=parseFloat(t),l(),$("#descuentosTotal").text("$"+c.toFixed(2))}),$("#generarDocumento").on("click",function(){p()})});function s(t=0,o=0,e=0){return(t*o-e).toFixed(4)}function l(){let t=0,o=0,e=0,n=0,i=0;r.forEach(a=>{e+=parseFloat(a.total)}),n=e-c,i=n+t+o,$("#reteIVA").text("$"+t.toFixed(2)),$("#reteRenta").text("$"+o.toFixed(2)),$("#subTotalGeneral").text("$"+e.toFixed(2)),$("#montoTotalOperacion").text("$"+n.toFixed(2)),$("#totalPagar").text("$"+i.toFixed(2)),$("#monto").val(i)}function p(){$("#loadingOverlay").removeClass("d-none");let t={};$("#checkContribuyente").prop("checked")?t={nombre:"Consumidor Final",telefono:null,correo:null,direccion:null,tipoDocumento:null,numDocumento:null}:t={nombre:$("#nombreContribuyente").val(),telefono:$("#telefonoContribuyente").val(),correo:$("#correoContribuyente").val(),direccion:{departamento:$("#departamentoContribuyente").val(),municipio:$("#municipioContribuyente").val(),complemento:$("#complementoContribuyente").val()},tipoDocumento:$("#tipoDoc").val(),numDocumento:$("#nitContribuyente").val()};let o={nit:$("#nit").val(),receptor:t,cuerpoDocumento:[],documentoRelacionado:null,ventaTercero:null,resumen:{descuNoSuj:0,descuExtenta:0,descuGravada:0,porcentajeDescuento:0,ivaRete1:0,reteRenta:0,saldoFavor:0,condicionOperacion:1},extension:null,apendice:null};r.forEach(e=>{o.cuerpoDocumento.push({cantidad:e.cantidad,codigo:"01",descripcion:e.descripcion,precioUni:e.precio,ventaGravada:e.total,ivaItem:(e.total/1.13*.13).toFixed(4)})}),$.ajax({url:"/business/factura",method:"POST",data:JSON.stringify(o),contentType:"application/json",success:function(e){e.status==201&&Swal.fire({icon:"success",title:"Factura generada",text:"La factura ha sido generada exitosamente",showConfirmButton:!1,timer:2e3}).then(()=>{$("#loadingOverlay").addClass("d-none"),window.location.href="/business/dtes"})},error:function(e){console.error(e),Swal.fire({icon:"error",title:"Error",text:"Ha ocurrido un error al generar la factura",showConfirmButton:!1,timer:2e3})}})}
