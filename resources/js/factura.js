const municipiosPorDepartamento = {
    '01': [{
        value: '01',
        text: '01 - AHUACHAPÁN'
    },
    {
        value: '02',
        text: '02 - APANECA'
    },
    {
        value: '03',
        text: '03 - ATIQUIZAYA'
    },
    {
        value: '04',
        text: '04 - CONCEPCIÓN DE ATACO'
    },
    {
        value: '05',
        text: '05 - EL REFUGIO'
    },
    {
        value: '06',
        text: '06 - GUAYMANGO'
    },
    {
        value: '07',
        text: '07 - JUJUTLA'
    },
    {
        value: '08',
        text: '08 - SAN FRANCISCO MENÉNDEZ'
    },
    {
        value: '09',
        text: '09 - SAN LORENZO'
    },
    {
        value: '10',
        text: '10 - SAN PEDRO PUXTLA'
    },
    {
        value: '11',
        text: '11 - TACUBA'
    },
    {
        value: '12',
        text: '12 - TURÍN'
    }
    ],
    '02': [{
        value: '01',
        text: '01 - CANDELARIA DE LA FRONTERA'
    },
    {
        value: '02',
        text: '02 - COATEPEQUE'
    },
    {
        value: '03',
        text: '03 - CHALCHUAPA'
    },
    {
        value: '04',
        text: '04 - EL CONGO'
    },
    {
        value: '05',
        text: '05 - EL PORVENIR'
    },
    {
        value: '06',
        text: '06 - MASAHUAT'
    },
    {
        value: '07',
        text: '07 - METAPÁN'
    },
    {
        value: '08',
        text: '08 - SAN ANTONIO PAJONAL'
    },
    {
        value: '09',
        text: '09 - SAN SEBASTIÁN SALITRILLO'
    },
    {
        value: '10',
        text: '10 - SANTA ANA'
    },
    {
        value: '11',
        text: '11 - STA ROSA GUACHI'
    },
    {
        value: '12',
        text: '12 - STGO D LA FRONT'
    },
    {
        value: '13',
        text: '13 - TEXISTEPEQUE'
    }
    ],
    '03': [{
        value: '01',
        text: '01 - ACAJUTLA'
    },
    {
        value: '02',
        text: '02 - ARMENIA'
    },
    {
        value: '03',
        text: '03 - CALUCO'
    },
    {
        value: '04',
        text: '04 - CUISNAHUAT'
    },
    {
        value: '05',
        text: '05 - STA I ISHUATAN'
    },
    {
        value: '06',
        text: '06 - IZALCO'
    },
    {
        value: '07',
        text: '07 - JUAYÚA'
    },
    {
        value: '08',
        text: '08 - NAHUIZALCO'
    },
    {
        value: '09',
        text: '09 - NAHULINGO'
    },
    {
        value: '10',
        text: '10 - SALCOATITÁN'
    },
    {
        value: '11',
        text: '11 - SAN ANTONIO DEL MONTE'
    },
    {
        value: '12',
        text: '12 - SAN JULIÁN'
    },
    {
        value: '13',
        text: '13 - STA C MASAHUAT'
    },
    {
        value: '14',
        text: '14 - SANTO DOMINGO GUZMÁN'
    },
    {
        value: '15',
        text: '15 - SONSONATE'
    },
    {
        value: '16',
        text: '16 - SONZACATE'
    }
    ],
    '04': [{
        value: '01',
        text: '01 - AGUA CALIENTE'
    },
    {
        value: '02',
        text: '02 - ARCATAO'
    },
    {
        value: '03',
        text: '03 - AZACUALPA'
    },
    {
        value: '04',
        text: '04 - CITALÁ'
    },
    {
        value: '05',
        text: '05 - COMALAPA'
    },
    {
        value: '06',
        text: '06 - CONCEPCIÓN QUEZALTEPEQUE'
    },
    {
        value: '07',
        text: '07 - CHALATENANGO'
    },
    {
        value: '08',
        text: '08 - DULCE NOM MARÍA'
    },
    {
        value: '09',
        text: '09 - EL CARRIZAL'
    },
    {
        value: '10',
        text: '10 - EL PARAÍSO'
    },
    {
        value: '11',
        text: '11 - LA LAGUNA'
    },
    {
        value: '12',
        text: '12 - LA PALMA'
    },
    {
        value: '13',
        text: '13 - LA REINA'
    },
    {
        value: '14',
        text: '14 - LAS VUELTAS'
    },
    {
        value: '15',
        text: '15 - NOMBRE DE JESUS'
    },
    {
        value: '16',
        text: '16 - NVA CONCEPCIÓN'
    },
    {
        value: '17',
        text: '17 - NUEVA TRINIDAD'
    },
    {
        value: '18',
        text: '18 - OJOS DE AGUA'
    },
    {
        value: '19',
        text: '19 - POTONICO'
    },
    {
        value: '20',
        text: '20 - SAN ANT LA CRUZ'
    },
    {
        value: '21',
        text: '21 - SAN ANT RANCHOS'
    },
    {
        value: '22',
        text: '22 - SAN FERNANDO'
    },
    {
        value: '23',
        text: '23 - SAN FRANCISCO LEMPA'
    },
    {
        value: '24',
        text: '24 - SAN FRANCISCO MORAZÁN'
    },
    {
        value: '25',
        text: '25 - SAN IGNACIO'
    },
    {
        value: '26',
        text: '26 - SAN I LABRADOR'
    },
    {
        value: '27',
        text: '27 - SAN J CANCASQUE'
    },
    {
        value: '28',
        text: '28 - SAN JOSE FLORES'
    },
    {
        value: '29',
        text: '29 - SAN LUIS CARMEN'
    },
    {
        value: '30',
        text: '30 - SN MIG MERCEDES'
    },
    {
        value: '31',
        text: '31 - SAN RAFAEL'
    },
    {
        value: '32',
        text: '32 - SANTA RITA'
    },
    {
        value: '33',
        text: '33 - TEJUTLA'
    }
    ],
    '05': [{
        value: '01',
        text: '01 - ANTGO CUSCATLÁN'
    },
    {
        value: '02',
        text: '02 - CIUDAD ARCE'
    },
    {
        value: '03',
        text: '03 - COLON'
    },
    {
        value: '04',
        text: '04 - COMASAGUA'
    },
    {
        value: '05',
        text: '05 - CHILTIUPAN'
    },
    {
        value: '06',
        text: '06 - HUIZÚCAR'
    },
    {
        value: '07',
        text: '07 - JAYAQUE'
    },
    {
        value: '08',
        text: '08 - JICALAPA'
    },
    {
        value: '09',
        text: '09 - LA LIBERTAD'
    },
    {
        value: '10',
        text: '10 - NUEVO CUSCATLÁN'
    },
    {
        value: '11',
        text: '11 - SANTA TECLA'
    },
    {
        value: '12',
        text: '12 - QUEZALTEPEQUE'
    },
    {
        value: '13',
        text: '13 - SACACOYO'
    },
    {
        value: '14',
        text: '14 - SN J VILLANUEVA'
    },
    {
        value: '15',
        text: '15 - SAN JUAN OPICO'
    },
    {
        value: '16',
        text: '16 - SAN MATÍAS'
    },
    {
        value: '17',
        text: '17 - SAN P TACACHICO'
    },
    {
        value: '18',
        text: '18 - TAMANIQUE'
    },
    {
        value: '19',
        text: '19 - TALNIQUE'
    },
    {
        value: '20',
        text: '20 - TEOTEPEQUE'
    },
    {
        value: '21',
        text: '21 - TEPECOYO'
    },
    {
        value: '22',
        text: '22 - ZARAGOZA'
    }
    ],
    '06': [{
        value: '01',
        text: '01 - AGUILARES'
    },
    {
        value: '02',
        text: '02 - APOPA'
    },
    {
        value: '03',
        text: '03 - AYUTUXTEPEQUE'
    },
    {
        value: '04',
        text: '04 - CUSCATANCINGO'
    },
    {
        value: '05',
        text: '05 - EL PAISNAL'
    },
    {
        value: '06',
        text: '06 - GUAZAPA'
    },
    {
        value: '07',
        text: '07 - ILOPANGO'
    },
    {
        value: '08',
        text: '08 - MEJICANOS'
    },
    {
        value: '09',
        text: '09 - NEJAPA'
    },
    {
        value: '10',
        text: '10 - PANCHIMALCO'
    },
    {
        value: '11',
        text: '11 - ROSARIO DE MORA'
    },
    {
        value: '12',
        text: '12 - SAN MARCOS'
    },
    {
        value: '13',
        text: '13 - SAN MARTIN'
    },
    {
        value: '14',
        text: '14 - SAN SALVADOR'
    },
    {
        value: '15',
        text: '15 - STG TEXACUANGOS'
    },
    {
        value: '16',
        text: '16 - SANTO TOMAS'
    },
    {
        value: '17',
        text: '17 - SOYAPANGO'
    },
    {
        value: '18',
        text: '18 - TONACATEPEQUE'
    },
    {
        value: '19',
        text: '19 - CIUDAD DELGADO'
    }
    ],
    '07': [{
        value: '01',
        text: '01 - CANDELARIA'
    },
    {
        value: '02',
        text: '02 - COJUTEPEQUE'
    },
    {
        value: '03',
        text: '03 - EL CARMEN'
    },
    {
        value: '04',
        text: '04 - EL ROSARIO'
    },
    {
        value: '05',
        text: '05 - MONTE SAN JUAN'
    },
    {
        value: '06',
        text: '06 - ORAT CONCEPCIÓN'
    },
    {
        value: '07',
        text: '07 - SAN B PERULAPIA'
    },
    {
        value: '08',
        text: '08 - SAN CRISTÓBAL'
    },
    {
        value: '09',
        text: '09 - SAN J GUAYABAL'
    },
    {
        value: '10',
        text: '10 - SAN P PERULAPÁN'
    },
    {
        value: '11',
        text: '11 - SAN RAF CEDROS'
    },
    {
        value: '12',
        text: '12 - SAN RAMON'
    },
    {
        value: '13',
        text: '13 - STA C ANALQUITO'
    },
    {
        value: '14',
        text: '14 - STA C MICHAPA'
    },
    {
        value: '15',
        text: '15 - SUCHITOTO'
    },
    {
        value: '16',
        text: '16 - TENANCINGO'
    }
    ],
    '08': [{
        value: '01',
        text: '01 - CUYULTITÁN'
    },
    {
        value: '02',
        text: '02 - EL ROSARIO'
    },
    {
        value: '03',
        text: '03 - JERUSALÉN'
    },
    {
        value: '04',
        text: '04 - MERCED LA CEIBA'
    },
    {
        value: '05',
        text: '05 - OLOCUILTA'
    },
    {
        value: '06',
        text: '06 - PARAÍSO OSORIO'
    },
    {
        value: '07',
        text: '07 - SN ANT MASAHUAT'
    },
    {
        value: '08',
        text: '08 - SAN EMIGDIO'
    },
    {
        value: '09',
        text: '09 - SN FCO CHINAMEC'
    },
    {
        value: '10',
        text: '10 - SAN J NONUALCO'
    },
    {
        value: '11',
        text: '11 - SAN JUAN TALPA'
    },
    {
        value: '12',
        text: '12 - SAN JUAN TEPEZONTES'
    },
    {
        value: '13',
        text: '13 - SAN LUIS TALPA'
    },
    {
        value: '14',
        text: '14 - SAN MIGUEL TEPEZONTES'
    },
    {
        value: '15',
        text: '15 - SAN PEDRO MASAHUAT'
    },
    {
        value: '16',
        text: '16 - SAN PEDRO NONUALCO'
    },
    {
        value: '17',
        text: '17 - SAN R OBRAJUELO'
    },
    {
        value: '18',
        text: '18 - STA MA OSTUMA'
    },
    {
        value: '19',
        text: '19 - STGO NONUALCO'
    },
    {
        value: '20',
        text: '20 - TAPALHUACA'
    },
    {
        value: '21',
        text: '21 - ZACATECOLUCA'
    },
    {
        value: '22',
        text: '22 - SN LUIS LA HERR'
    }
    ],
    '09': [{
        value: '01',
        text: '01 - CINQUERA'
    },
    {
        value: '02',
        text: '02 - GUACOTECTI'
    },
    {
        value: '03',
        text: '03 - ILOBASCO'
    },
    {
        value: '04',
        text: '04 - JUTIAPA'
    },
    {
        value: '05',
        text: '05 - SAN ISIDRO'
    },
    {
        value: '06',
        text: '06 - SENSUNTEPEQUE'
    },
    {
        value: '07',
        text: '07 - TEJUTEPEQUE'
    },
    {
        value: '08',
        text: '08 - VICTORIA'
    },
    {
        value: '09',
        text: '09 - DOLORES'
    }
    ],
    '10': [{
        value: '01',
        text: '01 - APASTEPEQUE'
    },
    {
        value: '02',
        text: '02 - GUADALUPE'
    },
    {
        value: '03',
        text: '03 - SAN CAY ISTEPEQ'
    },
    {
        value: '04',
        text: '04 - SANTA CLARA'
    },
    {
        value: '05',
        text: '05 - SANTO DOMINGO'
    },
    {
        value: '06',
        text: '06 - SN EST CATARINA'
    },
    {
        value: '07',
        text: '07 - SAN ILDEFONSO'
    },
    {
        value: '08',
        text: '08 - SAN LORENZO'
    },
    {
        value: '09',
        text: '09 - SAN SEBASTIÁN'
    },
    {
        value: '10',
        text: '10 - SAN VICENTE'
    },
    {
        value: '11',
        text: '11 - TECOLUCA'
    },
    {
        value: '12',
        text: '12 - TEPETITÁN'
    },
    {
        value: '13',
        text: '13 - VERAPAZ'
    }
    ],
    '11': [{
        value: '01',
        text: '01 - ALEGRÍA'
    },
    {
        value: '02',
        text: '02 - BERLÍN'
    },
    {
        value: '03',
        text: '03 - CALIFORNIA'
    },
    {
        value: '04',
        text: '04 - CONCEP BATRES'
    },
    {
        value: '05',
        text: '05 - EL TRIUNFO'
    },
    {
        value: '06',
        text: '06 - EREGUAYQUÍN'
    },
    {
        value: '07',
        text: '07 - ESTANZUELAS'
    },
    {
        value: '08',
        text: '08 - JIQUILISCO'
    },
    {
        value: '09',
        text: '09 - JUCUAPA'
    },
    {
        value: '10',
        text: '10 - JUCUARÁN'
    },
    {
        value: '11',
        text: '11 - MERCEDES UMAÑA'
    },
    {
        value: '12',
        text: '12 - NUEVA GRANADA'
    },
    {
        value: '13',
        text: '13 - OZATLÁN'
    },
    {
        value: '14',
        text: '14 - PTO EL TRIUNFO'
    },
    {
        value: '15',
        text: '15 - SAN AGUSTÍN'
    },
    {
        value: '16',
        text: '16 - SN BUENAVENTURA'
    },
    {
        value: '17',
        text: '17 - SAN DIONISIO'
    },
    {
        value: '18',
        text: '18 - SANTA ELENA'
    },
    {
        value: '19',
        text: '19 - SAN FCO JAVIER'
    },
    {
        value: '20',
        text: '20 - SANTA MARÍA'
    },
    {
        value: '21',
        text: '21 - STGO DE MARÍA'
    },
    {
        value: '22',
        text: '22 - TECAPÁN'
    },
    {
        value: '23',
        text: '23 - USULUTÁN'
    }
    ],
    '12': [{
        value: '01',
        text: '01 - CAROLINA'
    },
    {
        value: '02',
        text: '02 - CIUDAD BARRIOS'
    },
    {
        value: '03',
        text: '03 - COMACARÁN'
    },
    {
        value: '04',
        text: '04 - CHAPELTIQUE'
    },
    {
        value: '05',
        text: '05 - CHINAMECA'
    },
    {
        value: '06',
        text: '06 - CHIRILAGUA'
    },
    {
        value: '07',
        text: '07 - EL TRANSITO'
    },
    {
        value: '08',
        text: '08 - LOLOTIQUE'
    },
    {
        value: '09',
        text: '09 - MONCAGUA'
    },
    {
        value: '10',
        text: '10 - NUEVA GUADALUPE'
    },
    {
        value: '11',
        text: '11 - NVO EDÉN S JUAN'
    },
    {
        value: '12',
        text: '12 - QUELEPA'
    },
    {
        value: '13',
        text: '13 - SAN ANT D MOSCO'
    },
    {
        value: '14',
        text: '14 - SAN GERARDO'
    },
    {
        value: '15',
        text: '15 - SAN JORGE'
    },
    {
        value: '16',
        text: '16 - SAN LUIS REINA'
    },
    {
        value: '17',
        text: '17 - SAN MIGUEL'
    },
    {
        value: '18',
        text: '18 - SAN RAF ORIENTE'
    },
    {
        value: '19',
        text: '19 - SESORI'
    },
    {
        value: '20',
        text: '20 - ULUAZAPA'
    }
    ],
    '13': [{
        value: '01',
        text: '01 - ARAMBALA'
    },
    {
        value: '02',
        text: '02 - CACAOPERA'
    },
    {
        value: '03',
        text: '03 - CORINTO'
    },
    {
        value: '04',
        text: '04 - CHILANGA'
    },
    {
        value: '05',
        text: '05 - DELIC DE CONCEP'
    },
    {
        value: '06',
        text: '06 - EL DIVISADERO'
    },
    {
        value: '07',
        text: '07 - EL ROSARIO'
    },
    {
        value: '08',
        text: '08 - GUALOCOCTI'
    },
    {
        value: '09',
        text: '09 - GUATAJIAGUA'
    },
    {
        value: '10',
        text: '10 - JOATECA'
    },
    {
        value: '11',
        text: '11 - JOCOAITIQUE'
    },
    {
        value: '12',
        text: '12 - JOCORO'
    },
    {
        value: '13',
        text: '13 - LOLOTIQUILLO'
    },
    {
        value: '14',
        text: '14 - MEANGUERA'
    },
    {
        value: '15',
        text: '15 - OSICALA'
    },
    {
        value: '16',
        text: '16 - PERQUÍN'
    },
    {
        value: '17',
        text: '17 - SAN CARLOS'
    },
    {
        value: '18',
        text: '18 - SAN FERNANDO'
    },
    {
        value: '19',
        text: '19 - SAN FCO GOTERA'
    },
    {
        value: '20',
        text: '20 - SAN ISIDRO'
    },
    {
        value: '21',
        text: '21 - SAN SIMÓN'
    },
    {
        value: '22',
        text: '22 - SENSEMBRA'
    },
    {
        value: '23',
        text: '23 - SOCIEDAD'
    },
    {
        value: '24',
        text: '24 - TOROLA'
    },
    {
        value: '25',
        text: '25 - YAMABAL'
    },
    {
        value: '26',
        text: '26 - YOLOAIQUÍN'
    }
    ],
    '14': [{
        value: '01',
        text: '01 - ANAMOROS'
    },
    {
        value: '02',
        text: '02 - BOLÍVAR'
    },
    {
        value: '03',
        text: '03 - CONCEP DE OTE'
    },
    {
        value: '04',
        text: '04 - CONCHAGUA'
    },
    {
        value: '05',
        text: '05 - EL CARMEN'
    },
    {
        value: '06',
        text: '06 - EL SAUCE'
    },
    {
        value: '07',
        text: '07 - INTIPUCÁ'
    },
    {
        value: '08',
        text: '08 - LA UNIÓN'
    },
    {
        value: '09',
        text: '09 - LISLIQUE'
    },
    {
        value: '10',
        text: '10 - MEANG DEL GOLFO'
    },
    {
        value: '11',
        text: '11 - NUEVA ESPARTA'
    },
    {
        value: '12',
        text: '12 - PASAQUINA'
    },
    {
        value: '13',
        text: '13 - POLORÓS'
    },
    {
        value: '14',
        text: '14 - SAN ALEJO'
    },
    {
        value: '15',
        text: '15 - SAN JOSE'
    },
    {
        value: '16',
        text: '16 - SANTA ROSA LIMA'
    },
    {
        value: '17',
        text: '17 - YAYANTIQUE'
    },
    {
        value: '18',
        text: '18 - YUCUAIQUÍN'
    }
    ]
};

let items = [];
let descuentosTotal = 0;

$(function () {

    $.ajax({
        url: '/departamentos/all',
        success: function (apiResponse) {
            // Llenar el select de departamentos
            const departamentoSelect = $('#departamentoContribuyente');
            departamentoSelect.empty();
            apiResponse.forEach(departamento => {
                departamentoSelect.append(new Option(departamento.valores, departamento.codigo));
            });

            // Manejar el cambio del select de departamentos
            departamentoSelect.on('change', function () {
                const selectedDepartamento = $(this).val();
                const municipioSelect = $('#municipioContribuyente');

                // Limpiar el select de municipios
                municipioSelect.empty();

                if (selectedDepartamento) {
                    // Obtener los municipios del departamento seleccionado
                    const municipios = apiResponse.find(dept => dept.codigo === selectedDepartamento).municipios;

                    // Llenar el select de municipios
                    municipios.forEach(municipio => {
                        municipioSelect.append(new Option(municipio.valores, municipio.codigo));
                    });
                }
            });
            // Trigger the change event on page load to populate the municipios for the selected departamento
            $('#departamentoContribuyente').trigger('change');
        }
    })

    // Set a timeout to update #horaDTE every second
    setInterval(() => {
        $('#horaDTE').val(new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }));
    }, 1000);

    // Set the current date on #fechaDTE
    $('#fechaDTE').val(new Date().toISOString().split('T')[0]);

    $("#descuento, #cantidad, #precio").on("change", function () {
        let cantidad = $("#cantidad").val();
        let precio = $("#precio").val();
        let descuento = $("#descuento").val();
        let subtotal = calcular_subtotal_item(cantidad, precio, descuento);
        $("#total").val(subtotal);
    });

    $("#checkContribuyente").on("change", function () {
        if ($(this).prop("checked")) {
            console.log("checked");
            $("#nombreContribuyente").prop("disabled", true);
            $("#telefonoContribuyente").prop("disabled", true);
            $("#correoContribuyente").prop("disabled", true);
            $("#departamentoContribuyente").prop("disabled", true);
            $("#municipioContribuyente").prop("disabled", true);
            $("#complementoContribuyente").prop("disabled", true);
            $("#tipoDoc").prop("disabled", true);
            $("#nitContribuyente").prop("disabled", true);
        } else {
            console.log("unchecked");
            $("#nombreContribuyente").prop("disabled", false);
            $("#telefonoContribuyente").prop("disabled", false);
            $("#correoContribuyente").prop("disabled", false);
            $("#departamentoContribuyente").prop("disabled", false);
            $("#municipioContribuyente").prop("disabled", false);
            $("#complementoContribuyente").prop("disabled", false);
            $("#tipoDoc").prop("disabled", false);
            $("#nitContribuyente").prop("disabled", false);
        }
    });

    $("#agregar_item").on("click", function () {
        let unidad_id = $("#unidad").val();
        let unidad = $("#unidad option:selected").text();
        let cantidad = $("#cantidad").val();
        let precio = $("#precio").val();
        let descuento = $("#descuento").val() || 0;
        let total = $("#total").val();
        let descripcion = $("#producto").val();
        let item = {
            id: items.length + 1,
            unidad: unidad_id,
            cantidad: cantidad,
            precio: precio,
            descuento: descuento,
            total: total,
            descripcion: descripcion
        };
        items.push(item);
        $("#items").append(`<tr>
            <td>${unidad}</td>
            <td>${descripcion}</td>
            <td>${cantidad}</td>
            <td>$${parseFloat(precio).toFixed(2)}</td>
            <td>$${parseFloat(descuento).toFixed(2)}</td>
            <td>$${parseFloat(total).toFixed(2)}</td>
            <td>
                <button class="btn btn-danger btn-sm eliminar" data-id="${items.length + 1}">
                    Eliminar
                </button>
            </td>
        </tr>`);

        $("#cantidad").val("");
        $("#precio").val("");
        $("#descuento").val("");
        $("#total").val("");
        $("#producto").val("");
        calcular_totales();
    });

    $("#items").on("click", ".eliminar", function () {
        let id = $(this).data("id");
        items = items.filter(item => item.id !== id);
        $(this).closest("tr").remove();
        calcular_totales();
    });

    $("#guardarDescuento").on("click", function () {
        let descuento = $("#descVentasGravadas").val();
        descuentosTotal = parseFloat(descuento);
        calcular_totales();
        $("#descuentosTotal").text("$" + descuentosTotal.toFixed(2));
    });

    $("#generarDocumento").on("click", function () {
        generar_documento();
    });
});

function calcular_subtotal_item(cantidad = 0, precio = 0, descuento = 0) {
    return ((cantidad * precio) - descuento).toFixed(4);
}

function calcular_totales() {
    let reteIva = 0;
    let reteRenta = 0;
    let subTotalGeneral = 0;
    let montoTotalOperacion = 0;
    let totalPagar = 0;
    items.forEach(item => {
        subTotalGeneral += parseFloat(item.total);
    });
    montoTotalOperacion = subTotalGeneral - descuentosTotal;
    totalPagar = montoTotalOperacion + reteIva + reteRenta;

    $("#reteIVA").text("$" + reteIva.toFixed(2));
    $("#reteRenta").text("$" + reteRenta.toFixed(2));
    $("#subTotalGeneral").text("$" + subTotalGeneral.toFixed(2));
    $("#montoTotalOperacion").text("$" + montoTotalOperacion.toFixed(2));
    $("#totalPagar").text("$" + totalPagar.toFixed(2));
    $("#monto").val(totalPagar);
}

function generar_documento() {
    $("#loadingOverlay").removeClass("d-none")
    let receptor = {};
    if ($("#checkContribuyente").prop("checked")) {
        receptor = {
            "nombre": "Consumidor Final",
            "telefono": null,
            "correo": null,
            "direccion": null,
            "tipoDocumento": null,
            "numDocumento": null
        }
    } else {
        receptor = {
            "nombre": $("#nombreContribuyente").val(),
            "telefono": $("#telefonoContribuyente").val(),
            "correo": $("#correoContribuyente").val(),
            "direccion": {
                "departamento": $("#departamentoContribuyente").val(),
                "municipio": $("#municipioContribuyente").val(),
                "complemento": $("#complementoContribuyente").val()
            },
            "tipoDocumento": $("#tipoDoc").val(),
            "numDocumento": $("#nitContribuyente").val()
        }
    }

    let dte = {
        "nit": $("#nit").val(),
        "receptor": receptor,
        "cuerpoDocumento": [],
        "documentoRelacionado": null,
        "ventaTercero": null,
        "resumen": {
            "descuNoSuj": 0,
            "descuExtenta": 0,
            "descuGravada": 0,
            "porcentajeDescuento": 0,
            "ivaRete1": 0,
            "reteRenta": 0,
            "saldoFavor": 0,
            "condicionOperacion": 1
        },
        "extension": null,
        "apendice": null
    }

    items.forEach(item => {
        dte.cuerpoDocumento.push({
            "cantidad": item.cantidad,
            "codigo": "01",
            "descripcion": item.descripcion,
            "precioUni": item.precio,
            "ventaGravada": item.total,
            "ivaItem": ((item.total / 1.13) * 0.13).toFixed(4),
        });
    });

    $.ajax({
        url: "/business/factura",
        method: "POST",
        data: JSON.stringify(dte),
        contentType: "application/json",
        success: function (response) {
            if(response.status == 201){
                Swal.fire({
                    icon: 'success',
                    title: 'Factura generada',
                    text: 'La factura ha sido generada exitosamente',
                    showConfirmButton: false,
                    timer: 2000
                }).then(() => {
                    $("#loadingOverlay").addClass("d-none")
                    window.location.href = "/business/dtes";
                })
            }
        },
        error: function (error) {
            console.error(error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Ha ocurrido un error al generar la factura',
                showConfirmButton: false,
                timer: 2000
            })
        }
    });
}